<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>认证调试页面</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .debug-info { background: #f5f5f5; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .login-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center;
            z-index: 1000;
        }
        .login-prompt { 
            background: white; padding: 30px; border-radius: 10px; text-align: center; 
        }
        .login-btn { 
            background: #007bff; color: white; border: none; padding: 10px 20px; 
            border-radius: 5px; cursor: pointer; margin-top: 15px;
        }
    </style>
</head>
<body>
    <h1>🔍 认证状态调试</h1>
    
    <div class="debug-info">
        <h3>页面信息</h3>
        <p><strong>当前URL:</strong> <span id="current-url"></span></p>
        <p><strong>页面路径:</strong> <span id="current-path"></span></p>
    </div>

    <div class="debug-info">
        <h3>Meta标签检查</h3>
        <p><strong>auth-required meta:</strong> <span id="auth-meta"></span></p>
    </div>

    <div class="debug-info">
        <h3>Cookie信息</h3>
        <p><strong>所有Cookies:</strong> <span id="all-cookies"></span></p>
        <p><strong>sessionToken:</strong> <span id="session-token"></span></p>
    </div>

    <div class="debug-info">
        <h3>LocalStorage信息</h3>
        <p><strong>sessionToken:</strong> <span id="local-session-token"></span></p>
    </div>

    <div class="debug-info">
        <h3>DOM元素检查</h3>
        <p><strong>login-overlay元素:</strong> <span id="overlay-exists"></span></p>
        <p><strong>当前display样式:</strong> <span id="overlay-display"></span></p>
    </div>

    <div class="debug-info">
        <h3>操作测试</h3>
        <button onclick="showOverlay()">显示登录遮罩</button>
        <button onclick="hideOverlay()">隐藏登录遮罩</button>
        <button onclick="clearAuth()">清除认证信息</button>
    </div>

    <!-- 登录遮罩 -->
    <div id="login-overlay" class="login-overlay" style="display: none;">
        <div class="login-prompt">
            <h2>请先登录</h2>
            <p>使用 Gemini Playground 需要先登录账户</p>
            <button class="login-btn" onclick="goToLogin()">前往登录</button>
        </div>
    </div>

    <script>
        // 页面加载时执行调试
        document.addEventListener('DOMContentLoaded', () => {
            updateDebugInfo();
            
            // 模拟认证检查逻辑
            checkAuthDebug();
        });

        function updateDebugInfo() {
            document.getElementById('current-url').textContent = window.location.href;
            document.getElementById('current-path').textContent = window.location.pathname;
            
            // 检查meta标签
            const authMeta = document.querySelector('meta[name="auth-required"]');
            document.getElementById('auth-meta').textContent = authMeta ? authMeta.content : '未找到';
            
            // Cookie信息
            document.getElementById('all-cookies').textContent = document.cookie || '无';
            const sessionToken = getSessionTokenFromCookie();
            document.getElementById('session-token').textContent = sessionToken || '无';
            
            // LocalStorage信息
            document.getElementById('local-session-token').textContent = localStorage.getItem('sessionToken') || '无';
            
            // DOM元素检查
            const overlay = document.getElementById('login-overlay');
            document.getElementById('overlay-exists').textContent = overlay ? '存在' : '不存在';
            document.getElementById('overlay-display').textContent = overlay ? overlay.style.display : 'N/A';
        }

        function getSessionTokenFromCookie() {
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                const [name, value] = cookie.trim().split('=');
                if (name === 'sessionToken') {
                    return decodeURIComponent(value);
                }
            }
            return null;
        }

        function checkAuthDebug() {
            console.log('🔍 开始认证检查...');
            
            // 检查meta标签
            const authMeta = document.querySelector('meta[name="auth-required"]');
            if (authMeta && authMeta.content === 'true') {
                console.log('✅ 发现auth-required meta标签，应该显示登录遮罩');
                showOverlay();
                return;
            }
            
            // 检查sessionToken
            const sessionToken = getSessionTokenFromCookie() || localStorage.getItem('sessionToken');
            if (!sessionToken) {
                console.log('❌ 没有sessionToken，应该显示登录遮罩');
                showOverlay();
                return;
            }
            
            console.log('✅ 有sessionToken，需要验证有效性');
            // 这里应该调用API验证token
        }

        function showOverlay() {
            const overlay = document.getElementById('login-overlay');
            if (overlay) {
                overlay.style.display = 'flex';
                console.log('✅ 登录遮罩已显示');
                updateDebugInfo();
            } else {
                console.error('❌ 找不到登录遮罩元素');
            }
        }

        function hideOverlay() {
            const overlay = document.getElementById('login-overlay');
            if (overlay) {
                overlay.style.display = 'none';
                console.log('✅ 登录遮罩已隐藏');
                updateDebugInfo();
            }
        }

        function clearAuth() {
            document.cookie = 'sessionToken=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT';
            localStorage.removeItem('sessionToken');
            console.log('✅ 认证信息已清除');
            updateDebugInfo();
            checkAuthDebug();
        }

        function goToLogin() {
            window.location.href = '/login.html';
        }
    </script>
</body>
</html>
