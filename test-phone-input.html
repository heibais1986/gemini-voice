<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰‹æœºå·è¾“å…¥æµ‹è¯•</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 600px; margin: 0 auto; }
        .test-section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; }
        .btn { padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
        .btn:hover { background: #0056b3; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        .result { margin-top: 15px; padding: 10px; border-radius: 4px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .log { background: #f8f9fa; border: 1px solid #dee2e6; padding: 10px; border-radius: 4px; height: 200px; overflow-y: auto; font-family: monospace; font-size: 12px; }
    </style>
</head>
<body>
    <h1>ğŸ§ª æ‰‹æœºå·è¾“å…¥æ¡†æµ‹è¯•</h1>
    
    <div class="test-section">
        <h2>é—®é¢˜é‡ç°æµ‹è¯•</h2>
        <p>æµ‹è¯•ä¿®å¤å‰çš„IDå†²çªé—®é¢˜</p>
        
        <!-- æ¨¡æ‹ŸåŸæ¥çš„é—®é¢˜ç»“æ„ -->
        <div id="phone" style="display: none;">è¿™æ˜¯ä¸€ä¸ªdivï¼ŒIDä¸ºphone</div>
        
        <div class="form-group">
            <label for="phoneInput">æ‰‹æœºå·</label>
            <input type="tel" id="phoneInput" placeholder="è¯·è¾“å…¥æ‰‹æœºå·" value="13800138000">
        </div>
        
        <button class="btn" onclick="testPhoneInput()">æµ‹è¯•è·å–æ‰‹æœºå·</button>
        <button class="btn" onclick="testOldMethod()">æµ‹è¯•æ—§æ–¹æ³•(IDå†²çª)</button>
        
        <div id="testResult"></div>
    </div>

    <div class="test-section">
        <h2>éªŒè¯ç å‘é€æµ‹è¯•</h2>
        <p>æ¨¡æ‹Ÿç™»å½•é¡µé¢çš„éªŒè¯ç å‘é€åŠŸèƒ½</p>
        
        <div class="form-group">
            <label for="testPhone">æ‰‹æœºå·</label>
            <input type="tel" id="testPhone" placeholder="è¯·è¾“å…¥æ‰‹æœºå·" value="13800138000">
        </div>
        
        <button class="btn" id="sendTestCode" onclick="sendTestCode()">å‘é€éªŒè¯ç </button>
        
        <div class="form-group">
            <label for="testCode">éªŒè¯ç </label>
            <input type="text" id="testCode" placeholder="è¯·è¾“å…¥éªŒè¯ç " maxlength="6">
        </div>
        
        <button class="btn" onclick="testLogin()">æµ‹è¯•ç™»å½•</button>
        
        <div id="sendResult"></div>
    </div>

    <div class="test-section">
        <h2>æµ‹è¯•æ—¥å¿—</h2>
        <div id="log" class="log"></div>
        <button class="btn" onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
    </div>

    <script>
        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function showResult(elementId, message, type = 'info') {
            const resultDiv = document.getElementById(elementId);
            resultDiv.innerHTML = `<div class="result ${type}">${message}</div>`;
        }

        function testPhoneInput() {
            log('=== æµ‹è¯•æ–°æ–¹æ³•ï¼šgetElementById("phoneInput") ===');
            
            const phoneInput = document.getElementById('phoneInput');
            if (phoneInput) {
                const value = phoneInput.value;
                log(`âœ… æˆåŠŸè·å–åˆ°è¾“å…¥æ¡†å…ƒç´ `);
                log(`ğŸ“± æ‰‹æœºå·å€¼: "${value}"`);
                log(`ğŸ” å…ƒç´ ç±»å‹: ${phoneInput.tagName}`);
                
                if (value) {
                    showResult('testResult', `âœ… æˆåŠŸè·å–æ‰‹æœºå·: ${value}`, 'success');
                } else {
                    showResult('testResult', 'âš ï¸ æ‰‹æœºå·ä¸ºç©ºï¼Œè¯·è¾“å…¥æ‰‹æœºå·', 'error');
                }
            } else {
                log(`âŒ æ— æ³•æ‰¾åˆ°phoneInputå…ƒç´ `);
                showResult('testResult', 'âŒ æ— æ³•æ‰¾åˆ°phoneInputå…ƒç´ ', 'error');
            }
        }

        function testOldMethod() {
            log('=== æµ‹è¯•æ—§æ–¹æ³•ï¼šgetElementById("phone") ===');
            
            const phoneElement = document.getElementById('phone');
            if (phoneElement) {
                const value = phoneElement.value;
                log(`âš ï¸ è·å–åˆ°å…ƒç´ ï¼Œä½†ç±»å‹é”™è¯¯`);
                log(`ğŸ” å…ƒç´ ç±»å‹: ${phoneElement.tagName}`);
                log(`ğŸ“± å°è¯•è·å–value: "${value}"`);
                log(`âŒ è¿™å°±æ˜¯é—®é¢˜æ‰€åœ¨ï¼šè·å–åˆ°çš„æ˜¯divè€Œä¸æ˜¯input`);
                
                showResult('testResult', `âŒ IDå†²çªé—®é¢˜ï¼šè·å–åˆ°${phoneElement.tagName}å…ƒç´ ï¼Œvalueä¸ºundefined`, 'error');
            } else {
                log(`âŒ æ— æ³•æ‰¾åˆ°phoneå…ƒç´ `);
                showResult('testResult', 'âŒ æ— æ³•æ‰¾åˆ°phoneå…ƒç´ ', 'error');
            }
        }

        async function sendTestCode() {
            log('=== æµ‹è¯•å‘é€éªŒè¯ç  ===');
            
            const phone = document.getElementById('testPhone').value;
            const sendBtn = document.getElementById('sendTestCode');
            
            if (!phone) {
                log('âŒ æ‰‹æœºå·ä¸ºç©º');
                showResult('sendResult', 'âŒ è¯·è¾“å…¥æ‰‹æœºå·', 'error');
                return;
            }
            
            if (!/^1[3-9]\d{9}$/.test(phone)) {
                log('âŒ æ‰‹æœºå·æ ¼å¼ä¸æ­£ç¡®');
                showResult('sendResult', 'âŒ è¯·è¾“å…¥æ­£ç¡®çš„æ‰‹æœºå·æ ¼å¼', 'error');
                return;
            }
            
            log(`ğŸ“± å‡†å¤‡å‘é€éªŒè¯ç åˆ°: ${phone}`);
            sendBtn.disabled = true;
            sendBtn.textContent = 'å‘é€ä¸­...';
            
            try {
                // æ¨¡æ‹ŸAPIè°ƒç”¨
                const response = await fetch('/api/auth/send-code', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ phone })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    log(`âœ… éªŒè¯ç å‘é€æˆåŠŸ`);
                    log(`ğŸ’¡ æç¤º: ${data.hint || 'éªŒè¯ç å·²å‘é€'}`);
                    if (data.code) {
                        log(`ğŸ” å¼€å‘æ¨¡å¼éªŒè¯ç : ${data.code}`);
                        document.getElementById('testCode').value = data.code;
                    }
                    showResult('sendResult', `âœ… ${data.message}${data.hint ? '<br>ğŸ’¡ ' + data.hint : ''}`, 'success');
                    startCountdown(sendBtn);
                } else {
                    log(`âŒ å‘é€å¤±è´¥: ${data.message}`);
                    showResult('sendResult', `âŒ ${data.message}`, 'error');
                    sendBtn.disabled = false;
                    sendBtn.textContent = 'å‘é€éªŒè¯ç ';
                }
            } catch (error) {
                log(`âŒ ç½‘ç»œé”™è¯¯: ${error.message}`);
                showResult('sendResult', 'âŒ ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦å¯åŠ¨', 'error');
                sendBtn.disabled = false;
                sendBtn.textContent = 'å‘é€éªŒè¯ç ';
            }
        }

        function startCountdown(button) {
            let countdown = 60;
            const timer = setInterval(() => {
                button.textContent = `${countdown}ç§’åé‡å‘`;
                countdown--;
                
                if (countdown < 0) {
                    clearInterval(timer);
                    button.disabled = false;
                    button.textContent = 'å‘é€éªŒè¯ç ';
                }
            }, 1000);
        }

        async function testLogin() {
            log('=== æµ‹è¯•ç™»å½• ===');
            
            const phone = document.getElementById('testPhone').value;
            const code = document.getElementById('testCode').value;
            
            if (!phone || !code) {
                log('âŒ æ‰‹æœºå·æˆ–éªŒè¯ç ä¸ºç©º');
                showResult('sendResult', 'âŒ è¯·è¾“å…¥æ‰‹æœºå·å’ŒéªŒè¯ç ', 'error');
                return;
            }
            
            log(`ğŸ“± æ‰‹æœºå·: ${phone}`);
            log(`ğŸ” éªŒè¯ç : ${code}`);
            
            try {
                const response = await fetch('/api/auth/login/phone', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ phone, verificationCode: code })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    log(`âœ… ç™»å½•æˆåŠŸ`);
                    log(`ğŸ‘¤ ç”¨æˆ·ä¿¡æ¯: ${JSON.stringify(data.user)}`);
                    showResult('sendResult', 'âœ… ç™»å½•æˆåŠŸï¼', 'success');
                } else {
                    log(`âŒ ç™»å½•å¤±è´¥: ${data.message}`);
                    showResult('sendResult', `âŒ ${data.message}`, 'error');
                }
            } catch (error) {
                log(`âŒ ç½‘ç»œé”™è¯¯: ${error.message}`);
                showResult('sendResult', 'âŒ ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦å¯åŠ¨', 'error');
            }
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        // é¡µé¢åŠ è½½æ—¶çš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹æµ‹è¯•');
            log('è¿™ä¸ªé¡µé¢ç”¨äºæµ‹è¯•æ‰‹æœºå·è¾“å…¥æ¡†çš„IDå†²çªé—®é¢˜');
            log('ä¿®å¤å‰ï¼šIDå†²çªå¯¼è‡´è·å–åˆ°divè€Œä¸æ˜¯input');
            log('ä¿®å¤åï¼šä½¿ç”¨phoneInput IDé¿å…å†²çª');
        });
    </script>
</body>
</html>
